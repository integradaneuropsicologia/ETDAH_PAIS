<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ETDAH-PAIS</title>
<style>
  :root{--bg:#0f172a;--card:#111827;--line:#1f2937;--text:#e5e7eb;--muted:#94a3b8;--pri:#4f46e5;--ok:#22c55e;--err:#ef4444}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto}
  .wrap{max-width:980px;margin:24px auto;padding:0 16px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:18px}
  h1{margin:0 0 6px;font-size:1.35rem}
  .muted{color:var(--muted)}
  .grid-info{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin:12px 0 6px}
  @media(max-width:720px){.grid-info{grid-template-columns:1fr}}
  .info{background:#0b1220;border:1px solid var(--line);border-radius:10px;padding:10px}
  .info b{display:block;margin-bottom:4px;color:#cbd5e1}

  .legend{background:#0b1220;border:1px dashed var(--line);border-radius:10px;padding:10px;margin:6px 0 12px}

  .section{margin-top:18px; border-left:3px solid var(--line); padding-left:10px}
  .section h2{margin:0 0 6px; font-size:1.05rem; color:#cbd5e1}

  .q{border:1px solid var(--line);border-radius:12px;padding:12px;background:#0b1220}
  .q h3{margin:0 0 8px;font-size:1rem}
  .opts{display:flex;flex-wrap:wrap;gap:10px}
  label.opt{display:flex;align-items:center;gap:8px;padding:8px 12px;border:1px solid var(--line);border-radius:10px;cursor:pointer}
  .opt input[type="radio"]{accent-color:var(--pri)}
  /* botão inteiro azul quando marcado (CSS moderno) */
  label.opt:has(input[type="radio"]:checked){
    background:var(--pri); border-color:var(--pri); color:#fff;
  }
  label.opt:has(input[type="radio"]:checked) span{color:#fff;font-weight:600}
  label.opt:has(input[type="radio"]:focus-visible){
    box-shadow:0 0 0 3px rgba(79,70,229,.35); border-color:var(--pri);
  }

  .btn{display:inline-flex;align-items:center;gap:8px;background:var(--pri);border:none;color:#fff;padding:10px 14px;border-radius:10px;cursor:pointer}
  .btn.ok{background:var(--ok)}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .msg{margin:10px 0;padding:10px;border-radius:8px}
  .okbox{background:#052e1a;border:1px solid #114d2a;color:#b3f7c1}
  .errbox{background:#3b0d0d;border:1px solid #5b1919;color:#ffd0d0}
  .warnbox{background:#3a2903;border:1px solid #5c4307;color:#ffe6b0}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>ETDAH-PAIS</h1>
    <p class="muted">Considere o(a) filho(a) <b>no momento atual</b>, desde que os comportamentos ocorram nos <b>últimos 6 meses</b>. Marque: Nunca, Muito Pouco, Pouco, Geralmente, Frequentemente, Muito frequentemente.</p>
    
    <!-- Dados do paciente (via token) -->
    <div id="pacInfo" class="grid-info" style="display:none;"></div>

    <form id="form" style="margin-top:14px; display:none;">
      <div id="qs"></div>
      <div style="margin-top:14px;display:flex;gap:8px;align-items:center">
        <button id="btnSubmit" class="btn ok" type="submit">Enviar respostas</button>
        <div id="progress" class="muted"></div>
      </div>
      <div id="msg" class="msg" style="display:none"></div>
    </form>

    <div id="alert" class="msg" style="display:none"></div>
  </div>
</div>

<script>
// ======== CONFIG ========
const SHEETDB_BASE = "https://sheetdb.io/api/v1/8pmdh33s9fvy8";
const SHEETS = { PATIENTS:"Patients", TOKENS:"LinkTokens", SCORES:"Scores_ETDAH_PAIS" };
const CODE = "ETDAH_PAIS";
const PORTAL_URL = "https://integradaneuropsicologia.github.io/formularios/";

// ======== HELPERS ========
const $ = s => document.querySelector(s);
const onlyDigits = s => (s||"").replace(/\D+/g,"");
const qs = k => new URLSearchParams(location.search).get(k) || "";
const AUTOSAVE_KEY = `${CODE}_${qs("token")||"no_token"}`;

function setBox(id, text, kind="ok"){ const el=$(id); if(!el) return;
  el.textContent=text; el.className="msg "+(kind==="ok"?"okbox":kind==="warn"?"warnbox":"errbox"); el.style.display="block";
}
function hideBox(id){ const el=$(id); if(el){ el.style.display="none"; el.textContent=""; } }
function maskCPF(cpf){ const d=onlyDigits(cpf||""); if(d.length!==11) return cpf||""; return `${d.slice(0,3)}.${d.slice(3,6)}.${d.slice(6,9)}-${d.slice(9)}`; }
function fmtDateISO(iso){ if(!iso) return ""; const [y,m,d]=iso.split("-"); return (y&&m&&d)?`${d}/${m}/${y}`:iso; }
async function GET(url){ const r=await fetch(url); if(!r.ok) throw new Error("HTTP "+r.status); return r.json(); }
async function POST(url, body){ const r=await fetch(url,{method:"POST",headers:{ "Content-Type":"application/json" },body:JSON.stringify(body)}); if(!r.ok) throw new Error(await r.text()); return r.json(); }
async function PATCH(url, body){ const r=await fetch(url,{method:"PATCH",headers:{ "Content-Type":"application/json" },body:JSON.stringify(body)}); if(!r.ok) throw new Error(await r.text()); return r.json(); }
async function sheetSearch(sheet, params){ const usp=new URLSearchParams(params); return GET(`${SHEETDB_BASE}/search?sheet=${encodeURIComponent(sheet)}&${usp.toString()}`); }
async function sheetCreate(sheet, row){ return POST(`${SHEETDB_BASE}?sheet=${encodeURIComponent(sheet)}`, { data:[row] }); }
async function sheetPatchBy(sheet, column, value, data){ return PATCH(`${SHEETDB_BASE}/${encodeURIComponent(column)}/${encodeURIComponent(value)}?sheet=${encodeURIComponent(sheet)}`, { data }); }
function goPortalWithToken(){ const TOKEN=qs("token"); try{ const u=new URL(PORTAL_URL,location.href); u.searchParams.set("token",TOKEN); location.href=u.toString(); }catch(_){ const sep=PORTAL_URL.includes("?")?"&":"?"; location.href=PORTAL_URL+sep+"token="+encodeURIComponent(TOKEN); }}

// ======== ESCALA (1..6) ========
const CHOICES = [
  {label:"Nunca", value:1},
  {label:"Muito Pouco", value:2},
  {label:"Pouco", value:3},
  {label:"Geralmente", value:4},
  {label:"Frequentemente", value:5},
  {label:"Muito frequentemente", value:6},
];
const invert = s => (s ? 7 - s : 0); // 1↔6, 2↔5, 3↔4

// ======== ITENS (conforme instrumento) ========
const FORM = [
  {
    key: "RE", title: "FATOR 1 - REGULAÇÃO EMOCIONAL (RE)", invertAll: false, invertIds: [],
    items: [
      ["RE01","Faz amizade, mas não consegue mantê-la"],
      ["RE02","Implica com tudo"],
      ["RE03","Tem fortes reações emocionais (explosões de raiva)"],
      ["RE04","É irritadiço (tudo o incomoda)"],
      ["RE05","Muda facilmente de humor"],
      ["RE06","Explode com facilidade (é do tipo “pavio curto”)"],
      ["RE07","Dá a impressão de estar sempre insatisfeito (nada o agrada)"],
      ["RE08","É rebelde (não aceita nada)"],
      ["RE09","É agressivo"],
      ["RE10","Sente-se infeliz"],
      ["RE11","Faz birra quando quer algo"],
      ["RE12","Mostra-se tenso e rígido"],
      ["RE13","Implica com os irmãos"],
      ["RE14","As atividades e reuniões são desagradáveis"],
      ["RE15","Todos têm que fazer o que ele quer"],
      ["RE16","A hora de acordar e das refeições é desagradável"],
      ["RE17","Exige mais tempo e atenção dos pais do que os outros filhos"],
      ["RE18","Tem dificuldades para se adaptar às mudanças"],
    ]
  },
  {
    key: "HI", title: "FATOR 2 — HIPERATIVIDADE / IMPULSIVIDADE (HI)", invertAll: false, invertIds: [],
    items: [
      ["HI01","Movimenta-se muito (parece estar ligado com um motor ou a todo vapor)"],
      ["HI02","É inquieto e agitado"],
      ["HI03","Mexe-se e contorce-se durante as refeições e para realizar as tarefas de casa"],
      ["HI04","Tem sempre muita pressa"],
      ["HI05","Age sem pensar (é impulsivo)"],
      ["HI06","É inconsequente (não considera os perigos da situação)"],
      ["HI07","Intromete-se em assuntos que não lhe dizem respeito"],
      ["HI08","Responde antes de ouvir a pergunta inteira"],
      ["HI09","É imprudente"],
      ["HI10","Irrita os outros com suas palhaçadas"],
      ["HI11","Tende a discordar com as regras e normas de jogos"],
      ["HI12","É persistente e insiste diante de uma ideia"],
      ["HI13","Faz os deveres escolares rápido demais"],
    ]
  },
  {
    key: "CA", title: "FATOR 3 - COMPORTAMENTO ADAPTATIVO (CA)", invertAll: true, invertIds: [],
    items: [
      ["CA01","Aceita facilmente regras, normas e limites"],
      ["CA02","Parece ser uma criança tranquila e sossegada"],
      ["CA03","É tolerante, quando preciso"],
      ["CA04","Respeita normas e regras"],
      ["CA05","É obediente"],
      ["CA06","Obedece aos pais e as normas da casa"],
      ["CA07","Sabe aguardar sua vez (é paciente)"],
      ["CA08","Faz suas tarefas e almoça com bastante tranquilidade"],
      ["CA09","Faz as coisas com muito cuidado, prevendo todos os riscos de suas ações"],
      ["CA10","Seu comportamento é adequado socialmente"],
      ["CA11","Fala pouco"],
      ["CA12","A criança permite que o ambiente familiar seja tranquilo e harmonioso"],
      ["CA13","Consegue expressar claramente os seus pensamentos"],
      ["CA14","É atento quando conversa com alguém"],
    ]
  },
  {
    key: "A", title: "FATOR 4 - ATENÇÃO (A)", invertAll: false, invertIds: ["A01"], // apenas o primeiro invertido
    items: [
      ["A01","É independente para realizar as suas tarefas de casa"],
      ["A02","É distraído com quase tudo"],
      ["A03","Evita atividades que exigem esforço mental constante (deveres escolares, jogos)"],
      ["A04","Esquece rápido o que acabou de ser dito"],
      ["A05","Inicia uma atividade com entusiasmo e dificilmente chega ao final (é do tipo fogo de palha)"],
      ["A06","Tem dificuldade para realizar as coisas importantes (lição, por exemplo)"],
      ["A07","Não termina o que começa"],
      ["A08","Parece sonhar acordado (estar no mundo da lua)"],
      ["A09","Mostra-se concentrado apenas em atividades de seu interesse"],
      ["A10","Dá a impressão de que não ouve bem (só escuta o que quer)"],
      ["A11","Dificilmente observa detalhes"],
      ["A12","Ocorrem discussões entre os pais e a criança, em função da falta de responsabilidade e da falta de senso de dever"],
    ]
  }
];

// ======== RENDER ========
function renderQuestions(){
  const host = $("#qs"); host.innerHTML="";

  let count = 0;
  FORM.forEach(section=>{
    const sec = document.createElement("div");
    sec.className = "section";
    sec.innerHTML = `<h2>${section.title}</h2>`;
    section.items.forEach(([id,text])=>{
      count++;
      const wrap = document.createElement("div");
      wrap.className="q";
      const qn = id;
      wrap.setAttribute("role","group");
      wrap.setAttribute("aria-labelledby",`lbl_${qn}`);
      wrap.innerHTML = `<h3 id="lbl_${qn}">${text}</h3>`;
      const opts = document.createElement("div"); opts.className="opts";

      CHOICES.forEach((c, idx)=>{
        const htmlId = `${qn}_${idx+1}`;
        const lab = document.createElement("label"); lab.className="opt";
        lab.innerHTML = `<input type="radio" name="${qn}" id="${htmlId}" value="${c.value}" required><span>${c.label}</span>`;
        opts.appendChild(lab);
      });

      wrap.appendChild(opts);
      sec.appendChild(wrap);
    });
    host.appendChild(sec);
  });

  // progresso
  const progress = $("#progress");
  const updateProg = ()=>{
    const answered = document.querySelectorAll('#qs input[type="radio"]:checked').length;
    progress.textContent = `${answered}/${count} respondidas`;
  };
  host.addEventListener("change", ()=>{ updateProg(); autosaveAnswers(); });
  updateProg();
}

function autosaveAnswers(){
  const answers = {};
  FORM.forEach(sec=>{
    sec.items.forEach(([id,_])=>{
      const sel = document.querySelector(`input[name="${id}"]:checked`);
      if(sel) answers[id] = Number(sel.value);
    });
  });
  localStorage.setItem(AUTOSAVE_KEY, JSON.stringify({ code: CODE, token: qs("token"), answers }));
}
function restoreAutosave(){
  try{
    const raw = localStorage.getItem(AUTOSAVE_KEY); if(!raw) return;
    const { answers } = JSON.parse(raw) || {};
    if(!answers) return;
    Object.entries(answers).forEach(([id,val])=>{
      const el = document.querySelector(`input[name="${id}"][value="${val}"]`);
      if(el) el.checked = true;
    });
    const answered = Object.keys(answers).length;
    $("#progress").textContent = `${answered}/${document.querySelectorAll('.q').length} respondidas`;
  }catch(_){}
}
function clearAutosave(){ localStorage.removeItem(AUTOSAVE_KEY); }

// ======== ESTADO ========
let patient=null, tokenRow=null, CPF="";
let startAt = Date.now();

// ======== BOOT (token gating) ========
(async function boot(){
  try{
    const TOKEN = qs("token");
    if(!TOKEN){ setBox("#alert","Link inválido (sem token). Solicite um novo link.","err"); return; }

    // Token
    const trows = await sheetSearch(SHEETS.TOKENS, { token: TOKEN });
    if(!trows?.length) throw new Error("Token inválido ou expirado.");
    tokenRow = trows[0];
    const disabled = String(tokenRow.disabled||"não").toLowerCase()==="sim";
    const expired  = tokenRow.expires_at && (Date.parse(tokenRow.expires_at) < Date.now());
    if(disabled || expired) throw new Error("Token desativado/expirado. Peça um novo link.");

    // Paciente
    CPF = onlyDigits(tokenRow.cpf||"");
    if(!CPF) throw new Error("Token sem CPF vinculado.");
    const prows = await sheetSearch(SHEETS.PATIENTS, { cpf: CPF });
    if(!prows?.length) throw new Error("Paciente não encontrado.");
    patient = prows[0];

    // Liberação: coluna ETDAH_PAIS = "sim"
    const allowed = String(patient[CODE]||"").toLowerCase()==="sim";
    if(!allowed){ setBox("#alert","Este formulário não está liberado para você. Entre em contato com o consultório.","err"); return; }

    // Anti-duplicidade
    const flagDone = String(patient[`${CODE}_FEITO`]||"").toLowerCase()==="sim";
    const already  = await sheetSearch(SHEETS.SCORES, { cpf: CPF, code: CODE });
    if(flagDone || (already && already.length)){
      setBox("#alert","Você já respondeu este formulário. Voltando ao portal…","ok");
      setTimeout(goPortalWithToken,1200); return;
    }

    // Render
    renderPatientInfo();
    renderQuestions();
    $("#pacInfo").style.display="grid";
    $("#form").style.display="block";
    hideBox("#alert");
    startAt = Date.now();
    restoreAutosave();

  }catch(err){
    console.error(err);
    setBox("#alert", err.message || "Falha ao abrir o formulário. Tente novamente mais tarde.", "err");
  }
})();

function renderPatientInfo(){
  const g=$("#pacInfo"); g.innerHTML="";
  const info = [
    ["Nome", patient.nome || "-"],
    ["CPF", maskCPF(patient.cpf)],
    ["Nascimento", fmtDateISO(patient.data_nascimento)],
    ["E-mail", patient.email || "-"],
    ["WhatsApp", patient.whatsapp || "-"],
  ];
  for(const [k,v] of info){
    const div=document.createElement("div");
    div.className="info";
    div.innerHTML = `<b>${k}</b><div>${v||"-"}</div>`;
    g.appendChild(div);
  }
}

// ======== MONTAR CATEGORIA ========
function buildCategoria(sums){
  return `FATOR 1 (RE): ${sums.RE} | FATOR 2 (HI): ${sums.HI} | FATOR 3 (CA): ${sums.CA} | FATOR 4 (A): ${sums.A} | Escore total: ${sums.TOTAL}`;
}

// ======== SUBMIT ========
let sending=false;
$("#form").addEventListener("submit", async (e)=>{
  e.preventDefault();
  if(sending) return; sending=true; hideBox("#msg");
  const btn=$("#btnSubmit"); const originalText=btn.textContent; btn.disabled=true; btn.textContent="Enviando…";

  try{
    if(!patient) throw new Error("Sessão inválida. Recarregue o link.");

    // Coleta respostas
    const answers = {}; let firstMissing=null;
    FORM.forEach(sec=>{
      sec.items.forEach(([id,_])=>{
        const sel = document.querySelector(`input[name="${id}"]:checked`);
        if(!sel && firstMissing===null) firstMissing=id;
        if(sel) answers[id]=Number(sel.value);
      });
    });
    if(firstMissing){
      setBox("#msg", `Responda o item: ${firstMissing}.`, "warn");
      document.getElementById(`lbl_${firstMissing}`)?.scrollIntoView({behavior:"smooth", block:"center"});
      sending=false; btn.disabled=false; btn.textContent=originalText; return;
    }

    // Rechecagem anti-duplicidade
    const again = await sheetSearch(SHEETS.SCORES, { cpf: CPF, code: CODE });
    if(again && again.length){
      setBox("#msg","Este formulário já foi enviado anteriormente. Voltando ao portal…","ok");
      setTimeout(goPortalWithToken,1000); return;
    }

    // Cálculo por fator (com inversões)
    const invertMap = {};
    const sums = { RE:0, HI:0, CA:0, A:0, TOTAL:0 };

    FORM.forEach(sec=>{
      let secSum = 0;
      sec.items.forEach(([id,_], idx)=>{
        const raw = answers[id] || 0;
        const isInv = sec.invertAll || sec.invertIds.includes(id);
        invertMap[id] = !!isInv;
        const val = isInv ? invert(raw) : raw;
        secSum += val;
      });
      sums[sec.key] = secSum;
      sums.TOTAL += secSum;
    });

    const categoria = buildCategoria(sums);
    const durationSec = Math.round((Date.now()-startAt)/1000);

    const row = {
      result_id: `${patient.cpf}_${CODE}_${Date.now()}`,
      token: qs("token"),
      cpf: patient.cpf,
      code: CODE,
      source: "responsável",
      submitted_at: new Date().toISOString(),
      total: sums.TOTAL,               // Escore total (após ajustes)
      categoria,                       // String com os 4 fatores + total
      metrics: JSON.stringify({
        answers, sums, invert_map: invertMap, duration_sec: durationSec
      })
    };
    await sheetCreate(SHEETS.SCORES, row);

    await sheetPatchBy(SHEETS.PATIENTS,"cpf",patient.cpf,{ [`${CODE}_FEITO`]:"sim", [`${CODE}_FEITO_AT`]: new Date().toISOString() });

    clearAutosave();
    setBox("#msg","Formulário enviado. Retornando ao portal…","ok");
    setTimeout(goPortalWithToken, 1200);

  }catch(err){
    console.error(err);
    setBox("#msg", err.message || "Falha ao enviar. Tente novamente.", "err");
    sending=false; btn.disabled=false; btn.textContent=originalText;
  }
});
</script>
</body>
</html>

