<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ETDAH-PAIS</title>
<style>
  :root{
    --bg:#0e1625; --card:#14213b; --line:#2b3f66;
    --text:#f8fafc; --muted:#cbd5e1;
    --pri:#6d28d9; --ok:#10b981; --err:#ef4444; --warn:#f59e0b;
    --chip:#0b1220; --chipHover:#0f1a2e; --chipSel:#1e293b;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;background:var(--bg);color:var(--text);
    font:16px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu;
    -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
  }
  .wrap{max-width:1024px;margin:20px auto;padding:0 16px}
  .card{
    background:var(--card);
    border:1px solid var(--line);
    border-radius:14px;
    padding:18px
  }
  h1{margin:0 0 6px;font-size:1.45rem}
  .muted{color:var(--muted)}

  .grid-info{
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:12px;
    margin:12px 0 6px
  }
  @media (max-width:720px){.grid-info{grid-template-columns:1fr}}
  .info{
    background:rgba(0,0,0,.18);
    border:1px solid var(--line);
    border-radius:12px;
    padding:12px
  }
  .info b{
    display:block;
    margin-bottom:4px;
    color:#e2e8f0
  }

  .section{
    margin:18px 0 8px;
    padding:10px 12px;
    border:1px solid var(--line);
    border-radius:12px;
    background:rgba(0,0,0,.18);
    font-weight:700
  }

  /* ===== ITENS ===== */
  .item{
    border:1px solid var(--line);
    border-radius:12px;
    padding:12px;
    background:rgba(0,0,0,.18);
    margin-bottom:12px
  }
  .stem{
    font-size:1rem;
    margin-bottom:10px
  }

  .scale{
    display:grid;
    grid-template-columns:repeat(3,minmax(200px,1fr));
    gap:10px
  }
  @media (max-width:820px){
    .scale{grid-template-columns:1fr}
  }

  /* Botões (1..6) */
  .opt{
    display:flex;
    align-items:center;
    gap:10px;
    padding:10px 12px;
    border:1px solid var(--line);
    border-radius:12px;
    background:var(--chip);
    cursor:pointer;
    transition:background .15s ease,border-color .15s ease,transform .05s ease
  }
  .opt:hover{
    background:var(--chipHover);
    border-color:#4f70ff;
    transform:translateY(-1px)
  }
  .opt input{
    appearance:none;
    -webkit-appearance:none;
    width:0;
    height:0;
    position:absolute;
    opacity:0
  }
  .opt span{font-weight:600}
  .opt small{opacity:.8}
  .opt:has(input:checked){
    background:var(--chipSel);
    border-color:#6d28d9;
    box-shadow:0 0 0 1px #6d28d9 inset
  }

  .legend{
    display:flex;
    flex-wrap:wrap;
    gap:8px;
    margin:6px 0 12px
  }
  .pill{
    display:inline-block;
    padding:4px 8px;
    border-radius:999px;
    border:1px solid var(--line);
    background:rgba(0,0,0,.25);
    font-size:.86rem
  }

  /* Ações */
  .btn{
    display:inline-flex;
    align-items:center;
    gap:10px;
    background:var(--pri);
    border:none;
    color:#fff;
    padding:12px 16px;
    border-radius:12px;
    cursor:pointer;
    font-weight:600
  }
  .btn.ok{background:var(--ok)}
  .btn.ghost{
    background:transparent;
    border:1px solid var(--line);
    color:var(--muted)
  }
  .btn:disabled{
    opacity:.6;
    cursor:not-allowed
  }

  /* Mensagens */
  .msg{
    margin:12px 0;
    padding:12px;
    border-radius:10px
  }
  .okbox{
    background:#06351f;
    border:1px solid #0e6c45;
    color:#c8ffe3
  }
  .errbox{
    background:#3b0d0d;
    border:1px solid #7f1d1d;
    color:#ffd5d5
  }
  .warnbox{
    background:#3a2903;
    border:1px solid #885e09;
    color:#ffe6b0
  }

  /* Progresso */
  .progress{
    height:10px;
    background:rgba(255,255,255,.05);
    border:1px solid var(--line);
    border-radius:999px;
    overflow:hidden
  }
  .bar{
    height:100%;
    width:0%;
    background:linear-gradient(90deg,#6d28d9,#10b981)
  }
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>ETDAH-PAIS</h1>
    <p class="muted">
      Considere o(a) filho(a) <b>no momento atual</b>, pensando nos comportamentos que ocorreram nos <b>últimos 6 meses</b>.<br/>
      Marque uma opção para cada frase:<br/>
      <b>Nunca</b>, <b>Muito Pouco</b>, <b>Pouco</b>, <b>Geralmente</b>, <b>Frequentemente</b>, <b>Muito frequentemente</b>.
    </p>

    <!-- Dados do paciente (via token) -->
    <div id="pacInfo" class="grid-info" style="display:none;"></div>

    <!-- Progresso / rascunho -->
    <div id="progressWrap" style="display:none; gap:8px; align-items:center; margin:8px 0 0;">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;margin-bottom:6px;flex-wrap:wrap">
        <span class="muted" id="progressText">Progresso: 0/0</span>
        <div style="display:flex;flex-wrap:wrap;gap:8px">
          <button id="clearDraft" class="btn ghost" type="button" title="Limpar rascunho local">Limpar rascunho</button>
        </div>
      </div>
      <div class="progress"><div class="bar" id="bar"></div></div>
    </div>

    <form id="form" style="margin-top:14px; display:none;" novalidate>
      <div id="qs"></div>

      <div style="margin-top:14px;display:flex;gap:10px;flex-wrap:wrap">
        <button id="btnSubmit" class="btn ok" type="submit">Enviar respostas</button>
        <button id="btnSave" class="btn ghost" type="button" title="Salvar rascunho">Salvar rascunho</button>
      </div>

      <div id="msg" class="msg" style="display:none" role="alert" aria-live="polite"></div>
    </form>

    <div id="alert" class="msg" style="display:none" role="alert" aria-live="assertive"></div>
  </div>
</div>

<script>
/* ===== CONFIG ===== */
const SHEETDB_BASE = "https://sheetdb.io/api/v1/8pmdh33s9fvy8";
const SHEETS = {
  PATIENTS:"Patients",
  TOKENS:"LinkTokens",
  SCORES:"Scores_ETDAH_PAIS" // conferir o nome da aba na planilha
};
const CODE = "ETDAH_PAIS";
const PORTAL_URL = "https://integradaneuropsicologia.github.io/formularios/";
const RELEASE_KEYS = ["ETDAH_PAIS"]; // coluna(s) no Patients que liberam este formulário ("sim")

/* ===== HELPERS ===== */
const $ = s => document.querySelector(s);
const onlyDigits = s => (s||"").replace(/\D+/g,"");
const qs = k => new URLSearchParams(location.search).get(k) || "";

function setBox(id, text, kind="ok"){
  const el=$(id); if(!el) return;
  el.textContent = text;
  el.className = "msg " + (kind==="ok"?"okbox":kind==="warn"?"warnbox":"errbox");
  el.style.display = "block";
}
function hideBox(id){
  const el=$(id);
  if(el){
    el.style.display="none";
    el.textContent="";
  }
}
function maskCPF(cpf){
  const d = onlyDigits(cpf||"");
  if(d.length!==11) return cpf||"";
  return `${d.slice(0,3)}.${d.slice(3,6)}.${d.slice(6,9)}-${d.slice(9)}`;
}
function fmtDateISO(iso){
  if(!iso) return "";
  const [y,m,d] = String(iso).split("-");
  if(!y||!m||!d) return iso;
  return `${d}/${m}/${y}`;
}

async function GET(url){
  const r=await fetch(url);
  if(!r.ok) throw new Error("HTTP "+r.status);
  return r.json();
}
async function sheetSearch(sheet, params){
  const usp = new URLSearchParams(params);
  return GET(`${SHEETDB_BASE}/search?sheet=${encodeURIComponent(sheet)}&${usp.toString()}`);
}
async function sheetCreate(sheet, row){
  const r = await fetch(`${SHEETDB_BASE}?sheet=${encodeURIComponent(sheet)}`, {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({ data:[row] })
  });
  if(!r.ok) throw new Error(await r.text());
  return r.json();
}
async function sheetPatchBy(sheet, column, value, data){
  const r = await fetch(
    `${SHEETDB_BASE}/${encodeURIComponent(column)}/${encodeURIComponent(value)}?sheet=${encodeURIComponent(sheet)}`,
    {
      method:"PATCH",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ data })
    }
  );
  if(!r.ok) throw new Error(await r.text());
  return r.json();
}

const TOKEN = qs("token");
function goPortalWithToken(){
  try{
    const u = new URL(PORTAL_URL, location.href);
    if (TOKEN) u.searchParams.set("token", TOKEN);
    location.href = u.toString();
  }catch(_){
    const sep = PORTAL_URL.includes("?") ? "&" : "?";
    location.href = PORTAL_URL + (TOKEN ? sep + "token=" + encodeURIComponent(TOKEN) : "");
  }
}

/* ===== ESCALA (1..6) ===== */
const CHOICES = [
  {label:"Nunca", value:1},
  {label:"Muito Pouco", value:2},
  {label:"Pouco", value:3},
  {label:"Geralmente", value:4},
  {label:"Frequentemente", value:5},
  {label:"Muito frequentemente", value:6}
];

// inversão: 1↔6, 2↔5, 3↔4
function invertScore(v){
  if(!v && v!==0) return 0;
  return 7 - v;
}

/* ===== ITENS / FATORES =====
   RE  = Regulação Emocional
   HI  = Hiperatividade/Impulsividade
   CA  = Comportamento Adaptativo (itens todos invertidos)
   A   = Atenção (só A01 invertido)
*/
const FORM = [
  {
    key: "RE",
    title: "FATOR 1 — REGULAÇÃO EMOCIONAL (RE)",
    invertAll: false,
    invertIds: [],
    items: [
      ["RE01","Faz amizade, mas não consegue mantê-la"],
      ["RE02","Implica com tudo"],
      ["RE03","Tem fortes reações emocionais (explosões de raiva)"],
      ["RE04","É irritadiço (tudo o incomoda)"],
      ["RE05","Muda facilmente de humor"],
      ["RE06","Explode com facilidade (é do tipo “pavio curto”)"],
      ["RE07","Dá a impressão de estar sempre insatisfeito (nada o agrada)"],
      ["RE08","É rebelde (não aceita nada)"],
      ["RE09","É agressivo"],
      ["RE10","Sente-se infeliz"],
      ["RE11","Faz birra quando quer algo"],
      ["RE12","Mostra-se tenso e rígido"],
      ["RE13","Implica com os irmãos"],
      ["RE14","As atividades e reuniões são desagradáveis"],
      ["RE15","Todos têm que fazer o que ele quer"],
      ["RE16","A hora de acordar e das refeições é desagradável"],
      ["RE17","Exige mais tempo e atenção dos pais do que os outros filhos"],
      ["RE18","Tem dificuldades para se adaptar às mudanças"]
    ]
  },
  {
    key: "HI",
    title: "FATOR 2 — HIPERATIVIDADE / IMPULSIVIDADE (HI)",
    invertAll: false,
    invertIds: [],
    items: [
      ["HI01","Movimenta-se muito (parece estar ligado com um motor ou a todo vapor)"],
      ["HI02","É inquieto e agitado"],
      ["HI03","Mexe-se e contorce-se durante as refeições e para realizar as tarefas de casa"],
      ["HI04","Tem sempre muita pressa"],
      ["HI05","Age sem pensar (é impulsivo)"],
      ["HI06","É inconsequente (não considera os perigos da situação)"],
      ["HI07","Intromete-se em assuntos que não lhe dizem respeito"],
      ["HI08","Responde antes de ouvir a pergunta inteira"],
      ["HI09","É imprudente"],
      ["HI10","Irrita os outros com suas palhaçadas"],
      ["HI11","Tende a discordar com as regras e normas de jogos"],
      ["HI12","É persistente e insiste diante de uma ideia"],
      ["HI13","Faz os deveres escolares rápido demais"]
    ]
  },
  {
    key: "CA",
    title: "FATOR 3 — COMPORTAMENTO ADAPTATIVO (CA)",
    invertAll: true,
    invertIds: [],
    items: [
      ["CA01","Aceita facilmente regras, normas e limites"],
      ["CA02","Parece ser uma criança tranquila e sossegada"],
      ["CA03","É tolerante, quando preciso"],
      ["CA04","Respeita normas e regras"],
      ["CA05","É obediente"],
      ["CA06","Obedece aos pais e as normas da casa"],
      ["CA07","Sabe aguardar sua vez (é paciente)"],
      ["CA08","Faz suas tarefas e almoça com bastante tranquilidade"],
      ["CA09","Faz as coisas com muito cuidado, prevendo todos os riscos de suas ações"],
      ["CA10","Seu comportamento é adequado socialmente"],
      ["CA11","Fala pouco"],
      ["CA12","A criança permite que o ambiente familiar seja tranquilo e harmonioso"],
      ["CA13","Consegue expressar claramente os seus pensamentos"],
      ["CA14","É atento quando conversa com alguém"]
    ]
  },
  {
    key: "A",
    title: "FATOR 4 — ATENÇÃO (A)",
    invertAll: false,
    invertIds: ["A01"], // só o primeiro item invertido
    items: [
      ["A01","É independente para realizar as suas tarefas de casa"],
      ["A02","É distraído com quase tudo"],
      ["A03","Evita atividades que exigem esforço mental constante (deveres escolares, jogos)"],
      ["A04","Esquece rápido o que acabou de ser dito"],
      ["A05","Inicia uma atividade com entusiasmo e dificilmente chega ao final (é do tipo fogo de palha)"],
      ["A06","Tem dificuldade para realizar as coisas importantes (lição, por exemplo)"],
      ["A07","Não termina o que começa"],
      ["A08","Parece sonhar acordado (estar no mundo da lua)"],
      ["A09","Mostra-se concentrado apenas em atividades de seu interesse"],
      ["A10","Dá a impressão de que não ouve bem (só escuta o que quer)"],
      ["A11","Dificilmente observa detalhes"],
      ["A12","Ocorrem discussões entre os pais e a criança em função da falta de responsabilidade e da falta de senso de dever"]
    ]
  }
];

/* ===== RENDER ===== */
function renderQuestions(){
  const host = $("#qs"); host.innerHTML="";

  FORM.forEach(section=>{
    // bloco do fator
    const secDiv = document.createElement("div");
    secDiv.className = "section";
    secDiv.textContent = section.title;
    host.appendChild(secDiv);

    // itens
    section.items.forEach(([qid,text])=>{
      const row = document.createElement("div");
      row.className = "item";
      row.setAttribute("data-q", qid);

      const stem = document.createElement("div");
      stem.className = "stem";
      stem.id = `s_${qid}`;
      stem.textContent = text;

      const scale = document.createElement("div");
      scale.className = "scale";

      CHOICES.forEach(ch=>{
        const lab = document.createElement("label");
        lab.className = "opt";
        lab.setAttribute("title", `${ch.label} (${ch.value})`);
        const htmlId = `${qid}_${ch.value}`;
        lab.innerHTML = `
          <input type="radio"
            name="${qid}"
            id="${htmlId}"
            value="${ch.value}"
            required
            aria-labelledby="s_${qid}">
          <span>${ch.label}</span>
          <small></small>`;
        scale.appendChild(lab);
      });

      row.append(stem, scale);
      host.appendChild(row);
    });
  });
}

/* ===== ESTADO ===== */
let patient=null, tokenRow=null, CPF="";
const STORAGE_KEY = `ETDAH_PAIS_${TOKEN||'anon'}`;
let startAt = Date.now();

/* ===== RASCUNHO LOCAL ===== */
function saveDraft(){
  const data = {};
  FORM.forEach(sec=>{
    sec.items.forEach(([qid])=>{
      const sel = document.querySelector(`input[name="${qid}"]:checked`);
      if(sel) data[qid] = Number(sel.value);
    });
  });
  try{
    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
  }catch(e){
    console.warn("Sem espaço para salvar rascunho");
  }
}
function restoreDraft(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return;
    const data = JSON.parse(raw);
    for(const [qid,val] of Object.entries(data||{})){
      const el = document.querySelector(`input[name="${qid}"][value="${val}"]`);
      if(el){ el.checked = true; }
    }
  }catch(e){
    /* ignore */
  }
}
function clearDraft(){
  try{ localStorage.removeItem(STORAGE_KEY); }catch(e){}
}

/* ===== PROGRESSO ===== */
function countTotalItems(){
  return FORM.reduce((acc,sec)=>acc+sec.items.length,0);
}
function countAnswered(){
  let answered = 0;
  FORM.forEach(sec=>{
    sec.items.forEach(([qid])=>{
      if(document.querySelector(`input[name="${qid}"]:checked`)) answered++;
    });
  });
  return answered;
}
function updateProgress(){
  const ans = countAnswered();
  const tot = countTotalItems();
  $("#progressText").textContent = `Progresso: ${ans}/${tot}`;
  $("#bar").style.width = `${(ans/tot)*100}%`;
}

/* ===== COLETA PARA METRICS ===== */
function collectAnswersRaw(){
  const out = {};
  FORM.forEach(sec=>{
    sec.items.forEach(([qid])=>{
      const sel = document.querySelector(`input[name="${qid}"]:checked`);
      out[qid] = sel ? Number(sel.value) : null;
    });
  });
  return out;
}
function collectReadableAnswers(){
  const out = {};
  FORM.forEach(sec=>{
    sec.items.forEach(([qid,txt])=>{
      const sel = document.querySelector(`input[name="${qid}"]:checked`);
      const raw = sel ? Number(sel.value) : null;
      const lbl = sel
        ? (CHOICES.find(c=>c.value===raw)?.label || "")
        : "";
      const inv = sec.invertAll || sec.invertIds.includes(qid);
      const scored = (raw==null ? null : (inv ? invertScore(raw) : raw));
      out[qid] = {
        stem: txt,
        raw,
        label: lbl,
        inverted: !!inv,
        scored
      };
    });
  });
  return out;
}

/* ===== BOOT ===== */
(async function boot(){
  try{
    if(!TOKEN){
      setBox("#alert","Link inválido (sem token). Solicite um novo link.","err");
      return;
    }

    // valida token
    const trows = await sheetSearch(SHEETS.TOKENS, { token: TOKEN });
    if(!trows || !trows.length) throw new Error("Token inválido ou expirado.");
    tokenRow = trows[0];

    if(String(tokenRow.disabled||"não").toLowerCase()==="sim")
      throw new Error("Token desativado. Peça um novo link.");

    if(tokenRow.expires_at && new Date(tokenRow.expires_at) < new Date())
      throw new Error("Token expirado. Peça um novo link.");

    CPF = onlyDigits(tokenRow.cpf||"");
    if(!CPF) throw new Error("Token sem CPF vinculado.");

    // puxa paciente
    const prows = await sheetSearch(SHEETS.PATIENTS, { cpf: CPF });
    if(!prows || !prows.length) throw new Error("Paciente não encontrado.");
    patient = prows[0];

    // liberado?
    const isAllowed = RELEASE_KEYS.some(k =>
      String(patient[k]||"").trim().toLowerCase()==="sim"
    );
    if(!isAllowed){
      setBox("#alert","Este formulário não está liberado para você.","err");
      return;
    }

    // já respondeu?
    const doneKeys = RELEASE_KEYS.map(k => `${k}_FEITO`);
    const anyDoneFlag = doneKeys.some(k =>
      String(patient[k]||"").trim().toLowerCase()==="sim"
    );
    const already = await sheetSearch(SHEETS.SCORES, { cpf: CPF, code: CODE });
    if(anyDoneFlag || (already && already.length)){
      setBox("#alert","Você já respondeu este formulário. Voltando ao portal…","ok");
      setTimeout(goPortalWithToken,1200);
      return;
    }

    // render tela
    renderPatientInfo();
    renderQuestions();
    restoreDraft();
    updateProgress();

    $("#pacInfo").style.display="grid";
    $("#form").style.display="block";
    $("#progressWrap").style.display="block";
    hideBox("#alert");

    startAt = Date.now();
    devChecks();

  }catch(err){
    console.error(err);
    setBox("#alert", err.message || "Falha ao abrir o formulário. Tente novamente mais tarde.","err");
  }
})();

/* ===== PACIENTE HEADER ===== */
function renderPatientInfo(){
  const g=$("#pacInfo"); g.innerHTML="";
  const info = [
    ["Nome", patient.nome || "-"],
    ["CPF", maskCPF(patient.cpf)],
    ["Nascimento", fmtDateISO(patient.data_nascimento)],
    ["E-mail", patient.email || "-"],
    ["WhatsApp", patient.whatsapp || "-"]
  ];
  for(const [k,v] of info){
    const div = document.createElement("div");
    div.className = "info";
    div.innerHTML = `<b>${k}</b><div>${v||"-"}</div>`;
    g.appendChild(div);
  }
}

/* ===== EVENTOS DE UI ===== */
addEventListener('change', (e)=>{
  if(e.target && e.target.matches('input[type="radio"]')){
    saveDraft();
    updateProgress();
  }
});
$("#btnSave").addEventListener('click', ()=>{
  saveDraft();
  setBox('#msg','Rascunho salvo neste dispositivo.','ok');
});
$("#clearDraft").addEventListener('click', ()=>{
  clearDraft();
  setBox('#msg','Rascunho apagado.','warn');
});

/* ===== SUBMIT ===== */
let sending=false;
$("#form").addEventListener("submit", async (e)=>{
  e.preventDefault();
  if(sending) return;
  sending = true;
  hideBox("#msg");

  const btn = $("#btnSubmit");
  const originalText = btn.textContent;
  btn.disabled = true;
  btn.textContent = "Enviando…";

  try{
    if(!patient) throw new Error("Sessão inválida. Recarregue o link.");

    // valida: tudo respondido
    let firstMissing=null;
    FORM.forEach(sec=>{
      sec.items.forEach(([qid])=>{
        const sel = document.querySelector(`input[name="${qid}"]:checked`);
        if(!sel && firstMissing===null){
          firstMissing=qid;
        }
      });
    });
    if(firstMissing){
      setBox("#msg", `Responda o item: ${firstMissing}.`, "warn");
      document.getElementById(`s_${firstMissing}`)?.scrollIntoView({behavior:"smooth", block:"center"});
      sending=false;
      btn.disabled=false;
      btn.textContent=originalText;
      return;
    }

    // anti-duplicidade final
    const again = await sheetSearch(SHEETS.SCORES, { cpf: CPF, code: CODE });
    if(again && again.length){
      setBox("#msg","Este formulário já foi enviado anteriormente. Voltando ao portal…","ok");
      setTimeout(goPortalWithToken,1100);
      return;
    }

    // cálculos por fator
    const answersRaw = collectAnswersRaw();
    const answersReadable = collectReadableAnswers();

    const sums = { RE:0, HI:0, CA:0, A:0, TOTAL:0 };
    const maxMap = { RE:0, HI:0, CA:0, A:0, TOTAL:0 };
    const invertMap = {};

    FORM.forEach(sec=>{
      let secSum = 0;
      const secMax = sec.items.length * 6; // 6 é pontuação máxima possível (1..6)
      sec.items.forEach(([qid])=>{
        const raw = answersRaw[qid] || 0;
        const isInv = sec.invertAll || sec.invertIds.includes(qid);
        invertMap[qid] = !!isInv;
        const scored = isInv ? invertScore(raw) : raw;
        secSum += scored;
      });
      sums[sec.key] = secSum;
      maxMap[sec.key] = secMax;
      sums.TOTAL += secSum;
      maxMap.TOTAL += secMax;
    });

    const durationSec = Math.round((Date.now()-startAt)/1000);

    // % relativos
    const percent = {
      RE: Number((sums.RE / maxMap.RE).toFixed(4)),
      HI: Number((sums.HI / maxMap.HI).toFixed(4)),
      CA: Number((sums.CA / maxMap.CA).toFixed(4)),
      A:  Number((sums.A  / maxMap.A ).toFixed(4)),
      TOTAL: Number((sums.TOTAL / maxMap.TOTAL).toFixed(4))
    };

    // texto para PDF / parsing rápido
    const categoria_csv = [
      `RE=${sums.RE}`,
      `HI=${sums.HI}`,
      `CA=${sums.CA}`,
      `A=${sums.A}`
    ].join(',');

    // objeto rico (vai em metrics)
    const metricsObj = {
      sums,
      max: maxMap,
      percent,
      duration_sec: durationSec,
      answers_raw: answersRaw,
      answers_readable: answersReadable,
      invert_map: invertMap
    };

    // cria linha de resultado
    await sheetCreate(SHEETS.SCORES, {
      result_id: `${patient.cpf}_${CODE}_${Date.now()}`,
      token: TOKEN,
      cpf: patient.cpf,
      code: CODE,
      source: "responsável", // pai/mãe/cuidador
      submitted_at: new Date().toISOString(),
      total: sums.TOTAL,
      categoria: categoria_csv,
      metrics: "",
      questions: JSON.stringify(answersReadable),
      
    });

    // marcar feito
    const doneUpdates = {};
    RELEASE_KEYS.map(k=>`${k}_FEITO`).forEach(k=>{
      doneUpdates[k] = "sim";
    });
    doneUpdates[`${RELEASE_KEYS[0]}_FEITO_AT`] = new Date().toISOString();
    await sheetPatchBy(SHEETS.PATIENTS, "cpf", patient.cpf, doneUpdates);

    clearDraft();
    setBox("#msg","Formulário enviado. Voltando ao portal…","ok");
    setTimeout(goPortalWithToken,1100);

  }catch(err){
    console.error(err);
    setBox("#msg", err.message || "Falha ao enviar. Tente novamente.","err");
    sending=false;
    btn.disabled=false;
    btn.textContent=originalText;
  }
});

/* ===== DEV CHECKS ===== */
function devChecks(){
  const totalItems = countTotalItems(); // esperado 57
  if(totalItems !== 57){
    console.warn(`ETDAH-PAIS: esperado 57 itens, obtidos ${totalItems}`);
  }
  FORM.forEach(sec=>{
    sec.items.forEach(([qid])=>{
      if(!document.querySelector(`input[name="${qid}"]`)){
        console.warn("Campo ausente:",qid);
      }
    });
  });
}
</script>
</body>
</html>
